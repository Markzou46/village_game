<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古村异闻录</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SimSun', '宋体', serif;
            background-color: #0a0a0a;
            color: #d4c5a9;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #8b0000;
            padding-bottom: 20px;
        }

        .game-title {
            font-size: 2.5em;
            color: #8b0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 10px;
        }

        .scene-container {
            background: radial-gradient(circle at center, rgba(15, 5, 5, 0.9), rgba(5, 0, 0, 0.95));
            border: 1px solid #8b0000;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(139, 0, 0, 0.4), inset 0 0 40px rgba(139, 0, 0, 0.1);
            position: relative;
        }

        .scene-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 25% 25%, rgba(139, 0, 0, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 75% 75%, rgba(139, 0, 0, 0.05) 0%, transparent 40%);
            pointer-events: none;
            border-radius: 8px;
        }

        .scene-text {
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 30px;
            min-height: 150px;
            white-space: pre-wrap;
            color: #d4c5a9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice-button {
            background: rgba(10, 5, 5, 0.6);
            border: 1px solid #8b0000;
            color: #d4c5a9;
            padding: 15px 25px;
            font-size: 1.1em;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.4s ease;
            text-align: left;
            width: 100%;
            border-radius: 4px;
            letter-spacing: 0.05em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 0, 0, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .choice-button:hover {
            background: rgba(139, 0, 0, 0.25);
            border-color: #b22222;
            color: #ffffff;
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 4px 20px rgba(139, 0, 0, 0.4), inset 0 0 15px rgba(139, 0, 0, 0.1);
            text-shadow: 0 0 10px rgba(139, 0, 0, 0.6);
        }

        .choice-button:hover::before {
            left: 100%;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .control-button {
            background: transparent;
            border: 1px solid #666;
            color: #888;
            padding: 8px 20px;
            font-size: 0.9em;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .control-button:hover {
            background: rgba(139, 0, 0, 0.2);
            border-color: #8b0000;
            color: #d4c5a9;
        }

        /* 标题画面容器优化布局 */
        .scene-container[data-scene="title_screen"] {
            background: radial-gradient(circle at center, rgba(20, 0, 0, 0.9), rgba(0, 0, 0, 0.95));
            border: 2px solid #8b0000;
            box-shadow: 0 0 40px rgba(139, 0, 0, 0.3), inset 0 0 60px rgba(139, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .scene-container[data-scene="title_screen"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 0, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 0, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .scene-container[data-scene="title_screen"] .scene-text {
            position: relative;
            z-index: 2;
        }

        /* 标题画面按钮特殊样式 */
        .scene-container[data-scene="title_screen"] .control-button {
            background: rgba(30, 0, 0, 0.8);
            border: 2px solid #8b0000;
            color: #d4c5a9;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            letter-spacing: 0.15em;
            margin: 10px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            text-shadow: 0 0 5px rgba(139, 0, 0, 0.8);
            min-width: 160px;
        }

        .scene-container[data-scene="title_screen"] .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 0, 0, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .scene-container[data-scene="title_screen"] .control-button:hover::before {
            left: 100%;
        }

        .scene-container[data-scene="title_screen"] .control-button:hover {
            background: rgba(178, 34, 34, 0.4);
            border-color: #ff4444;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(178, 34, 34, 0.8);
            box-shadow: 0 0 30px rgba(178, 34, 34, 0.6), inset 0 0 20px rgba(178, 34, 34, 0.2);
            transform: scale(1.08) translateY(-2px);
        }

        /* 标题画面选项容器样式 */
        .scene-container[data-scene="title_screen"] .choices-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-top: 2em;
            position: relative;
            z-index: 3;
        }

        /* 为标题画面添加额外的恐怖效果 */
        .scene-container[data-scene="title_screen"] {
            animation: subtle-glow 8s infinite alternate;
        }

        @keyframes subtle-glow {
            0%, 100% { box-shadow: 0 0 40px rgba(139, 0, 0, 0.3), inset 0 0 60px rgba(139, 0, 0, 0.1); }
            50% { box-shadow: 0 0 60px rgba(139, 0, 0, 0.5), inset 0 0 80px rgba(139, 0, 0, 0.2); }
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-button:disabled:hover {
            background: transparent;
            border-color: #666;
            color: #888;
            transform: none;
            box-shadow: none;
        }

        .status-bar {
            background: linear-gradient(135deg, rgba(20, 5, 5, 0.95), rgba(10, 10, 10, 0.9));
            border: 1px solid #8b0000;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(139, 0, 0, 0.3), inset 0 0 20px rgba(139, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #b22222, transparent);
            opacity: 0.6;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-label {
            color: #888;
            font-size: 0.9em;
        }

        .status-value {
            color: #d4c5a9;
            font-weight: bold;
        }

        .sanity-bar {
            width: 150px;
            height: 20px;
            background: linear-gradient(90deg, rgba(50, 0, 0, 0.9), rgba(20, 0, 0, 0.8));
            border: 1px solid #8b0000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 0 10px rgba(139, 0, 0, 0.2);
        }

        .sanity-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b0000, #b22222, #ff6b6b);
            transition: width 0.5s ease;
            box-shadow: 0 0 15px rgba(139, 0, 0, 0.6), inset 0 0 10px rgba(255, 107, 107, 0.3);
            position: relative;
        }

        .sanity-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        .inventory {
            background: linear-gradient(135deg, rgba(15, 5, 5, 0.9), rgba(5, 5, 5, 0.85));
            border: 1px solid #8b0000;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(139, 0, 0, 0.2), inset 0 0 15px rgba(139, 0, 0, 0.1);
        }

        .inventory-title {
            color: #8b0000;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .inventory-item {
            color: #d4c5a9;
            margin: 5px 0;
            padding: 5px;
            background: rgba(50, 50, 50, 0.3);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .glitch {
            animation: glitch 0.3s;
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
            25% { text-shadow: 3px 3px 6px rgba(139,0,0,0.8), 0 0 30px rgba(139,0,0,0.8), 2px 2px 3px rgba(0,0,0,0.9); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            .scene-container {
                padding: 20px;
            }
            .game-title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <h1 class="game-title">古村异闻录</h1>
            <p style="color: #888; font-size: 0.9em;">一个关于中元节与封建迷信的故事</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">理智值:</span>
                <div class="sanity-bar">
                    <div class="sanity-fill" id="sanityBar" style="width: 80%"></div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-label">村民好感度:</span>
                <span class="status-value" id="trustLevel">0</span>
            </div>
            <div class="status-item">
                <span class="status-label" id="timeDisplay">农历七月初一 夜</span>
            </div>
        </div>

        <div class="inventory" id="inventory">
            <div class="inventory-title">物品栏</div>
            <div id="inventoryList"></div>
        </div>

        <main class="scene-container">
            <div class="scene-text" id="sceneText">正在加载游戏...</div>
            <div class="choices-container" id="choicesContainer"></div>
        </main>
    </div>

    <script>
        // 立即执行，防止加载问题
        console.log('Game script loaded');

        // 游戏状态
        const gameState = {
            currentScene: 'title_screen',
            sanity: 80,
            trustLevel: 0,
            inventory: [],
            flags: {
                hasSpokenToElder: false,
                knowsWellSecret: false,
                isPossessed: false,
                hasTalisman: false,
                hasAncestralKey: false,
                festivalPrepared: false,
                supernaturalEvents: 0
            },
            choices: [],
            choiceHistory: [], // 历史记录，用于回退
            currentDay: 1,
            isNight: true,
            gameOver: false,
            gameStarted: false
        };

        // 场景数据
        const scenes = {
            title_screen: {
                text: `<div style="text-align: center; font-family: SimSun, serif; padding: 2em 1em;">
<div style="font-size: 0.8em; color: #996; letter-spacing: 1em; margin-bottom: 2em; opacity: 0.8;">中元节 · 鬼门开 · 百鬼夜行</div>

<div style="margin: 1.5em 0;">
<h1 style="font-size: 4em; color: #b22222; text-shadow: 0 0 20px rgba(178,34,34,0.8), 2px 2px 4px rgba(0,0,0,0.9); margin: 0; letter-spacing: 0.3em; animation: flicker 4s infinite alternate; font-weight: bold; line-height: 1.2;">古村异闻录</h1>
</div>

<div style="font-size: 1.3em; color: #999; margin: 2em 0; font-style: italic; opacity: 0.7; letter-spacing: 0.1em;">「七月半 · 鬼乱窜 · 纸钱飞 · 香火断」</div>

<div style="border-top: 1px solid #8b0000; border-bottom: 1px solid #8b0000; padding: 1.5em; margin: 2em auto; max-width: 400px; background: rgba(10,10,10,0.6);">
<div style="color: #aaa; font-size: 1em; line-height: 1.8; text-align: center;">
你，一名民俗学学生<br>
在中元节回到祖籍村庄<br>
<span style="color: #b22222; font-style: italic;">记录那些不该被记录的习俗</span><br>
<span style="color: #ff4444; font-size: 0.9em;">有些秘密，永远不该被唤醒...</span>
</div>
</div>

<div style="font-size: 0.9em; color: #8b0000; animation: pulse 3s infinite; margin-top: 2em; opacity: 0.8;">
⚠️ 心理恐怖 · 胆小勿入 ⚠️
</div>
</div>`,
                choices: [
                    { text: '〖踏入险境〗', nextScene: 'village_entrance', effect: { resetGame: true } },
                    { text: '〖继续轮回〗', nextScene: null, special: 'load' },
                    { text: '〖游戏说明〗', nextScene: 'about', special: 'about' }
                ],
                isTitleScreen: true
            },
            about: {
                text: '\n\n关于 游戏说明\n\n─────────────\n\n《古村异闻录》是一款文字冒险游戏。\n\n你扮演一名民俗学专业的学生，在中元节期间回到祖籍村庄，准备记录这里的独特习俗。\n\n然而，你逐渐发现这个村庄隐藏着一个古老的秘密...\n\n\n操作说明：\n• 点击选项进行选择\n• 按数字键1-9快速选择\n• ESC键返回标题画面\n\n游戏特色：\n• 50+场景，多重结局\n• 理智值系统\n• 自动保存进度\n\n\n按任意键返回...',
                choices: [
                    { text: '[返回]', nextScene: 'title_screen' }
                ]
            },
            village_entrance: {
                text: '你拖着疲惫的身体来到了这个偏远的山村。\n\n作为民俗学专业的学生，你选择在中元节期间回到祖籍村庄，准备记录这里独特的鬼节习俗。村子入口处，一棵巨大的榕树下坐着几位老人，他们用审视的目光打量着你这个外来者。\n\n空气中弥漫着一股若有若无的香火味，远处隐约传来诵经的声音...',
                choices: [
                    { text: '主动上前与老人打招呼', nextScene: 'talk_to_elders', effect: { trustLevel: 10 } },
                    { text: '默默走进村子，先找住处', nextScene: 'find_lodging', effect: { sanity: -5 } },
                    { text: '先在村口观察一下情况', nextScene: 'observe_village', effect: { flags: { supernaturalEvents: 1 } } }
                ]
            },
            talk_to_elders: {
                text: '"年轻人，不是本地人吧？"一位留着山羊胡的老人开口道，他的眼神让你有些不自在。\n\n"我是来学习的民俗学学生，想记录村里的中元节习俗。"你礼貌地回答。\n\n老人摇了摇头："这里的事情，不是外人该了解的。现在回头还来得及，马上就是七月半了..." 旁边的几位老人也用忧虑的眼神看着你。',
                choices: [
                    { text: '坚持要留下来研究', nextScene: 'refuse_warning', effect: { flags: { hasSpokenToElder: true }, trustLevel: -10 } },
                    { text: '询问为什么这里这么特别', nextScene: 'ask_about_secrets', effect: { flags: { hasSpokenToElder: true }, sanity: -10 } },
                    { text: '感谢提醒但表示自己能处理', nextScene: 'confident_response', effect: { flags: { hasSpokenToElder: true }, trustLevel: 5 } }
                ]
            },
            find_lodging: {
                text: '你避开了村口的老人，直接向村子深处走去。\n\n古老的青石板路在脚下发出了轻微的声响，两旁的房屋都是传统的明清建筑，但大多数都显得破败不堪。奇怪的是，几乎每家门口都贴着黄色的符纸。\n\n终于，你在一间看起来还算完整的房子前停下，门楣上挂着"李氏宗祠"的牌匾。',
                choices: [
                    { text: '敲门询问是否有空房', nextScene: 'knock_ancestral_hall', effect: { flags: { hasAncestralKey: false } } },
                    { text: '先绕着房子转一圈看看', nextScene: 'explore_hall', effect: { flags: { supernaturalEvents: 1 }, sanity: -5 } },
                    { text: '继续往前找其他住处', nextScene: 'find_other_house', effect: { sanity: -10 } }
                ]
            },
            observe_village: {
                text: '你选择在村口的榕树下静静观察。\n\n这棵榕树异常庞大，树干上缠绕着许多红色的丝带，有些已经褪色，有些还很新鲜。树下有一个小小的香炉，里面插满了燃尽的香。\n\n突然，一阵阴风吹过，榕树的叶子发出沙沙的声响，仿佛在低声诉说着什么。',
                choices: [
                    { text: '仔细查看香炉里的香', nextScene: 'examine_incense', effect: { flags: { supernaturalEvents: 1 } } },
                    { text: '触摸那些红色丝带', nextScene: 'touch_ribbons', effect: { sanity: -15, flags: { isPossessed: true } } },
                    { text: '现在进村子', nextScene: 'enter_village_after_observation', effect: {} }
                ]
            },
            refuse_warning: {
                text: '"固执的年轻人..."老人叹了口气，"既然你执意如此，记住几点：天黑后不要出门，不要回应任何呼唤你的声音，最重要的是，绝对不要靠近村后的那口古井。"\n\n说完，老人们便不再理会你，继续他们的谈话，但你能感觉到他们的目光时不时地飘向你。',
                choices: [
                    { text: '感谢老人并记住警告', nextScene: 'remember_warnings', effect: { flags: { hasSpokenToElder: true } } },
                    { text: '追问古井的具体位置和故事', nextScene: 'ask_about_well', effect: { flags: { knowsWellSecret: true }, sanity: -10 } },
                    { text: '不以为然地离开', nextScene: 'disregard_warnings', effect: { sanity: -20, trustLevel: -20 } }
                ]
            },
            ask_about_secrets: {
                text: '老人的脸色变得更加严肃："这里的秘密，不是用来说的，是用来敬畏的。每年七月半，村里都会举行祭祀仪式，安抚那些...不安分的魂灵。"\n\n他压低声音："你看，天色不早了，还是先找个地方住下吧。宗祠那里应该还有空房间，但是..."他欲言又止。',
                choices: [
                    { text: '直接去宗祠', nextScene: 'go_to_ancestral_hall', effect: { flags: { hasSpokenToElder: true } } },
                    { text: '追问"但是"后面的内容', nextScene: 'press_for_details', effect: { sanity: -15, flags: { supernaturalEvents: 1 } } },
                    { text: '先在村里转转再决定', nextScene: 'wander_village', effect: { sanity: -10 } }
                ]
            },
            confident_response: {
                text: '"年轻人有胆量是好事，但胆量不能替代敬畏。"老人微微点头，"既然你坚持，这个给你。"他从怀里掏出一张黄色的符纸，"贴身戴着，关键时刻能保命。"\n\n符纸散发着淡淡的檀香味，上面用朱砂画着复杂的符号。',
                choices: [
                    { text: '恭敬地收下符纸', nextScene: 'accept_talisman', effect: { flags: { hasTalisman: true, hasSpokenToElder: true }, trustLevel: 10 } },
                    { text: '礼貌地拒绝，表示自己不需要', nextScene: 'refuse_talisman', effect: { flags: { hasSpokenToElder: true }, trustLevel: -15 } },
                    { text: '询问符纸的来历和用法', nextScene: 'ask_about_talisman', effect: { flags: { hasSpokenToElder: true, hasTalisman: true }, trustLevel: 5 } }
                ]
            },
            knock_ancestral_hall: {
                text: '你敲响了宗祠的大门。良久，门内传来脚步声，门吱呀一声开了一道缝。\n\n一个中年男子探出头："有事吗？天快黑了，不是接待的时候。"\n\n你说明来意后，他犹豫了一下："既然是刘老介绍来的...进来吧。但是要记住，晚上待在房间里不要乱走。"',
                choices: [
                    { text: '道谢后进入宗祠', nextScene: 'enter_ancestral_hall', effect: { sanity: -5 } },
                    { text: '询问为什么晚上不能乱走', nextScene: 'ask_about_night_rules', effect: { sanity: -10 } },
                    { text: '决定不住这里，另找地方', nextScene: 'leave_hall', effect: { sanity: -15 } }
                ]
            },
            explore_hall: {
                text: '你绕着宗祠走了一圈。建筑保存得相当完好，青砖黛瓦，飞檐翘角。但在后院，你发现了一口被封死的古井。\n\n井口用厚重的石板盖着，上面贴满了符纸，地上还有散落的纸钱。更奇怪的是，你隐约听到井底传来若有若无的哭声...',
                choices: [
                    { text: '试图移开石板看看', nextScene: 'try_open_well', effect: { sanity: -20, flags: { knowsWellSecret: true, supernaturalEvents: 2 } } },
                    { text: '立即离开这个诡异的地方', nextScene: 'flee_well', effect: { flags: { supernaturalEvents: 1 }, sanity: -10 } },
                    { text: '在这里撒些纸钱以示敬畏', nextScene: 'offer_paper_money', effect: { sanity: 5, trustLevel: 10 } }
                ]
            },
            find_other_house: {
                text: '你继续在村中寻找住处。越往里走，村子显得越发破败。大多数房屋都大门紧锁，门上挂着锁链。\n\n天色渐暗，一盏昏黄的灯笼在远处亮起。走近一看，是一个小杂货铺，门口坐着一位老婆婆在纳鞋底。',
                choices: [
                    { text: '上前询问是否有房间出租', nextScene: 'ask_granny', effect: { sanity: 5 } },
                    { text: '买些日用品顺便打听消息', nextScene: 'buy_goods', effect: { trustLevel: 5 } },
                    { text: '转身回到宗祠', nextScene: 'return_to_hall', effect: { sanity: -10 } }
                ]
            },
            examine_incense: {
                text: '你蹲下身仔细查看香炉。里面的香灰堆积得很厚，说明这里经常有人来祭拜。奇怪的是，你发现了一些新鲜的水果和硬币作为供品。\n\n当你伸手想去拿供品时，一个声音在你耳边响起："别拿死人的东西..."',
                choices: [
                    { text: '惊恐地收回手', nextScene: 'retract_hand', effect: { sanity: -15 }, supernaturalEvent: true },
                    { text: '四下看来是谁在说话', nextScene: 'look_for_speaker', effect: { sanity: -10, flags: { supernaturalEvents: 2 } } },
                    { text: '无视警告拿走一个硬币', nextScene: 'take_coin', effect: { inventory: ['古币'], sanity: -20, flags: { isPossessed: true } } }
                ]
            },
            touch_ribbons: {
                text: '当你触摸那些红色丝带时，一股冰冷的寒意顺着手臂传遍全身。周围突然安静下来，连蝉鸣都消失了。\n\n你仿佛听到了许多人的低语，他们在诉说着什么...渐渐地，你发现自己分不清这些声音是来自外界，还是自己的脑海里...',
                choices: [
                    { text: '用力挣脱，大声念经文', nextScene: 'recite_sutras', effect: { sanity: -10 } },
                    { text: '试着倾听那些声音在说什么', nextScene: 'listen_to_voices', effect: { sanity: -30, flags: { supernaturalEvents: 3 } } },
                    { text: '立即转身离开榕树', nextScene: 'flee_banyan', effect: { sanity: -5 } }
                ]
            },
            enter_village_after_observation: {
                text: '你正式踏入了这个神秘的村庄。街道上空无一人，但每家每户都能闻到饭菜的香味，偶尔传来女人的笑声和孩子的哭声。\n\n奇怪的是，这些声音都让你感到一种说不出的诡异感。',
                choices: [
                    { text: '直接去宗祠寻找住处', nextScene: 'go_to_ancestral_hall', effect: {} },
                    { text: '循着声音寻找村民', nextScene: 'follow_sounds', effect: { sanity: -15, flags: { supernaturalEvents: 2 } } },
                    { text: '找个人询问村里情况', nextScene: 'find_villager', effect: {} }
                ]
            },
            look_for_speaker: {
                text: '你猛地回头，但身后空无一人。榕树下依然是那几位老人，他们似乎没有注意到你这里的异常。\n\n"年轻人，你在找什么？"山羊胡老人问道。\n\n"刚才有人在我耳边说话..."你有些困惑地说。\n\n老人脸色一变："是它们在找你。快，天黑前必须找到一个庇护之所！"',
                choices: [
                    { text: '立即去宗祠', nextScene: 'rush_to_hall', effect: { flags: { hasSpokenToElder: true } } },
                    { text: '问"它们"指的是什么', nextScene: 'ask_about_them', effect: { sanity: -20 } },
                    { text: '说自己不怕，继续探索', nextScene: 'brave_exploration', effect: { sanity: -30, flags: { supernaturalEvents: 3 } } }
                ]
            },
            rush_to_hall: {
                text: '你急匆匆地跑向李氏宗祠。老人在你身后喊道："记住锁好门，不要给任何人开门！"\n\n当你到达宗祠时，天色已经完全暗了下来。宗祠的大门敞开着，里面透出昏黄的灯光。刚才的中年男子正站在门口等你。\n\n"快进来，它们来了..."他紧张地说道。',
                choices: [
                    { text: '立刻进入并锁门', nextScene: 'lock_hall_door', effect: { sanity: 5 } },
                    { text: '问"它们"到底是谁', nextScene: 'ask_who_coming', effect: { sanity: -15 } },
                    { text: '回头看看"它们"是什么', nextScene: 'look_back', effect: { sanity: -30, flags: { isPossessed: true } } }
                ]
            },
            ask_about_them: {
                text: '老人的脸色变得惨白："死去的人...不甘愿死去的人。每年的七月半，它们都会回来，寻找替身..."\n\n其他老人都紧张地看着周围。"快去吧，还有人要见你呢。"\n\n果然，宗祠的方向传来了一声呼喊，似乎在叫你的名字。',
                choices: [
                    { text: '立即前往宗祠', nextScene: 'go_to_ancestral_hall', effect: { flags: { hasSpokenToElder: true } } },
                    { text: '问谁在叫自己的名字', nextScene: 'ask_caller', effect: { sanity: -20, flags: { supernaturalEvents: 2 } } },
                    { text: '询问如何保护自己', nextScene: 'ask_protection', effect: { flags: { hasTalisman: true }, trustLevel: 10 } }
                ]
            },
            brave_exploration: {
                text: '你无视警告，继续向村子深处探索。夜幕降临，整个村庄陷入一片诡异的寂静。\n\n每走一步，你都能感觉到无数双眼睛在暗中注视着你。偶尔，你会看到人影在巷子深处一闪而过，但当你追过去时，却什么都没有。\n\n突然，一个穿白衣的女孩出现在你前方不远处...',
                choices: [
                    { text: '上前搭话', nextScene: 'talk_to_girl', effect: { sanity: -40, flags: { isPossessed: true } } },
                    { text: '立即转身逃跑', nextScene: 'run_away', effect: { sanity: -20 } },
                    { text: '躲在一旁观察', nextScene: 'hide_and_watch', effect: { sanity: -10 } }
                ]
            },
            lock_hall_door: {
                text: '你迅速进入宗祠，中年男子立刻将沉重的木门锁上，还用门栓加固。\n\n"暂时安全了。"他松了一口气，"我是这里的守祠人，叫我李叔吧。你会在这里住下，但必须遵守规矩。"\n\n他递给你一盏油灯："今晚待在房间里，无论听到什么都不要出来。"',
                choices: [
                    { text: '询问具体有什么规矩', nextScene: 'ask_rules', effect: { flags: { hasSpokenToElder: true, KnowsHallRules: true } } },
                    { text: '直接去房间休息', nextScene: 'go_to_room', effect: { sanity: 5 } },
                    { text: '问刚才外面到底是什么', nextScene: 'ask_about_outside', effect: { sanity: -15 } }
                ]
            },
            ask_who_coming: {
                text: '"每年的祭品..."守祠人李叔的声音有些颤抖，"今年轮到我们家接待外来者了。快进来，让它们看见就糟了！"\n\n你顺着他的目光望去，远处的雾气中似乎有许多人影在移动，但他们的动作很僵硬，像是...木偶。',
                choices: [
                    { text: '快速跑进宗祠', nextScene: 'enter_hall_quickly', effect: { sanity: -10 } },
                    { text: '拿出手机拍照', nextScene: 'take_photo', effect: { sanity: -30, flags: { supernaturalEvents: 3 } } },
                    { text: '试图与那些人影交流', nextScene: 'approach_figures', effect: { sanity: -50, flags: { isPossessed: true } } }
                ]
            },
            look_back: {
                text: '你好奇地回头望去。只见一群穿着古装的人正向村口走来，他们的脸色惨白，眼神空洞。最诡异的是，他们的脚没有着地，在离地几厘米的高度漂浮着...\n\n为首的老太太对你笑了笑："年轻人，终于来了。我们等你好久了..."',
                choices: [
                    { text: '尖叫着跑向宗祠', nextScene: 'scream_to_hall', effect: { sanity: -20 } },
                    { text: '站在原地不动', nextScene: 'stand_still', effect: { flags: { isPossessed: true }, gameOver: true } },
                    { text: '念诵刚学的经文', nextScene: 'recite_defense', effect: { flags: { hasTalisman: true }, sanity: -30 } }
                ]
            },
            go_to_room: {
                text: '李叔带你来到二楼的一间客房。房间很简单，只是一张床和一个书桌，但收拾得很干净。\n\n"这是你今晚的房间。"他说道，"记住，不要回应任何敲门声，不要往窗外看，更不要...照镜子。"\n\n说完，他离开了房间，你还听到了锁门的声音。',
                choices: [
                    { text: '躺在床上休息', nextScene: 'rest_bed', effect: { sanity: 10 } },
                    { text: '查看书桌上的东西', nextScene: 'check_desk', effect: { flags: { knowsWellSecret: true } } },
                    { text: '照镜子看看发生了什么', nextScene: 'look_mirror', effect: { sanity: -25, flags: { isPossessed: true } } }
                ]
            },
            check_desk: {
                text: '书桌上放着一本发黄的旧日记本。你打开看了看，上面记载着前几年住在这里的人的经历...\n\n"七月十五，他们说祭祀只是个形式。但我听到了井里的哭声...\n\n"七月十六，我看到了不该看的东西。她告诉了我关于古井的秘密...\n\n"七月十七，我想离开，但已经太晚了..."',
                choices: [
                    { text: '继续阅读日记', nextScene: 'continue_diary', effect: { sanity: -30, flags: { supernaturalEvents: 2 } } },
                    { text: '合上日记去睡觉', nextScene: 'sleep_after_diary', effect: { sanity: -15 } },
                    { text: '寻找关于古井的更多线索', nextScene: 'search_well_clues', effect: { flags: { knowsWellSecret: true, supernaturalEvents: 1 } } }
                ]
            },
            rest_bed: {
                text: '你躺在床上，但无论如何也睡不着。外面传来各种奇怪的声音 - 有女人的哭泣声，有孩子的嬉笑声，还有...什么东西在爬行的声音。\n\n突然，门被敲响了："开门呀，我是李叔，有急事..."',
                choices: [
                    { text: '相信他是李叔，开门', nextScene: 'open_door_li', effect: { sanity: -40, flags: { isPossessed: true } } },
                    { text: '不搭理，继续装睡', nextScene: 'ignore_knock', effect: { sanity: 5 } },
                    { text: '问"你刚才不是说要待在房间里吗"', nextScene: 'question_knocker', effect: { sanity: -10 } }
                ]
            },
            ignore_knock: {
                text: '你选择不理会门外的声音。敲门声持续了很久，然后渐渐消失了。\n\n就在你松一口气的时候，窗外传来了声音："开门呀，我在这里..."一个女声在你耳边轻语。\n\n你惊恐地发现，声音不是从窗外传来的，而是从...房间里面！',
                choices: [
                    { text: '躲在被子里发抖', nextScene: 'hide_blanket', effect: { sanity: -20 } },
                    { text: '冲向门口试图逃跑', nextScene: 'rush_escape', effect: { sanity: -30 } },
                    { text: '大喊"我知道你是谁"', nextScene: 'confront_ghost', effect: { sanity: -10, flags: { hasTalisman: true } } }
                ]
            },
            hide_blanket: {
                text: '你躲进被子里，闭上眼睛，但那声音越来越近："出来吧，出来吧，不要害怕..."你感觉到有什么东西在触摸你的被子...\n\n突然，被子被掀开了！一个穿着白衣、长发遮脸的女孩正站在床边看着你...',
                choices: [
                    { text: '尖叫', nextScene: 'scream_encounter', effect: { sanity: -50 } },
                    { text: '询问她是谁', nextScene: 'ask_ghost_identity', effect: { sanity: -30 } },
                    { text: '拿出符纸护身', nextScene: 'use_talisman', effect: { sanity: -10, flags: { hasTalisman: false } } }
                ]
            },
            scream_encounter: {
                text: '你的尖叫声在房间里回荡，但鬼影只是静静地站在那里。渐渐地，你发现自己发不出声音了...\n\n"没用的。"女孩终于说话了，声音轻柔却令人毛骨悚然，"三年前，也有人像你这样尖叫。现在，轮到你了..."\n\n【结局：永恒的祭品】\n\n你成为了这个村庄新的祭品，灵魂被永远困在古井中，等待下一个外来者的到来...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            use_talisman: {
                text: '你想起老人给的符纸，立刻掏出贴身持有。符纸突然自燃，发出金色的光芒！\n\n"啊！"女孩发出一声惨叫，身形变得飘忽不定，"怎么会...你怎么会有镇魂符？\n\n光芒散去后，女孩消失了，但你听到她在远处说："你逃不掉的...七月十五之前，你必须选择..."',
                choices: [
                    { text: '立刻离开这个村庄', nextScene: 'flee_village', effect: { sanity: 10, trustLevel: -30 } },
                    { text: '寻找更多镇魂符', nextScene: 'find_more_charms', effect: { sanity: -20 } },
                    { text: '调查七月十五的秘密', nextScene: 'investigate_festival', effect: { sanity: -15 } }
                ]
            },
            investigate_festival: {
                text: '你决定留下来调查七月十五的秘密。通过在村里的探索，你逐渐了解了真相：\n\n这个村庄有一个古老的诅咒，每年必须献祭一个外来者，才能保全村平安。那些"死去的人"，其实是历年的祭品...\n\n现在距离七月十五只有几天了，你必须想办法打破这个诅咒。',
                choices: [
                    { text: '尝试从内部破坏祭祀', nextScene: 'sabotage_ritual', effect: { sanity: -30 } },
                    { text: '寻找诅咒的根源古井', nextScene: 'find_well_source', effect: { sanity: -40, flags: { knowsWellSecret: true } } },
                    { text: '联合村民反抗', nextScene: 'unite_villagers', effect: { trustLevel: 50 } }
                ]
            },
            unite_villagers: {
                text: '你决定说服村民们一起反抗这个邪恶的传统。出乎意料的是，很多年轻人其实早就想改变这一切。\n\n"我奶奶就是前年的祭品..."一个年轻人说，"我们不能再这样下去了。"\n\n在越来越多村民的支持下，你们决定在七月十五那天举行反抗仪式...',
                choices: [
                    { text: '主持新的仪式驱逐邪灵', nextScene: 'new_exorcism', effect: { sanity: -20, trustLevel: 20 } },
                    { text: '摧毁古井切断诅咒源头', nextScene: 'destroy_well', effect: { sanity: -50, flags: { supernaturalEvents: 5 } } },
                    { text: '用自己代替祭品换取村民解脱', nextScene: 'sacrifice_self', effect: { gameOver: true, goodEnding: true } }
                ]
            },
            sacrifice_self: {
                text: '你做出了一个艰难的决定。在七月十五那天，你主动走向祭坛...\n\n"我愿意成为最后的祭品。"你对着村民们说，"但这个传统必须到此为止。让我用生命，为这个村庄带来真正的解脱。"\n\n当仪式进行到高潮时，你的身体化为金光，笼罩了整个村庄。所有的怨灵都被超度，村民们流着泪感谢你的牺牲...\n\n【结局：救赎之光】\n\n你用自己的生命换来了整个村庄的解脱，成为了这个村子的守护神...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            destroy_well: {
                text: '在村民的帮助下，你找到了那口被封印的古井。当井盖被打开的那一刻，无数怨灵涌出...\n\n"就是现在！"你大喊着，将火把扔向井内。井中传来一声巨响，整个地面开始震动。\n\n光芒过后，所有的怨灵都消失了，古井也坍塌了。诅咒终于被打破...',
                choices: [
                    { text: '离开村庄', nextScene: 'leave_freely', effect: { sanity: 50 } },
                    { text: '留下来帮助村民重建', nextScene: 'stay_rebuild', effect: { trustLevel: 100 } },
                    { text: '记录这一切并发表', nextScene: 'publish_story', effect: { sanity: 30 } }
                ]
            },
            leave_freely: {
                text: '诅咒解除后，你终于可以自由地离开村庄了。村民们依依不含地为你送行，曾经恐惧的村子现在充满了生机。\n\n"这个故事，永远不会有外人知道了。"守祠人李叔拍着你的肩膀，"但我们会记住你。"\n\n回望村庄，那棵大榕树下，再也没有诡异的红色丝带了...\n\n【结局：自由的归途】\n\n你成功打破了村庄的诅咒，带着这段神奇的经历回到了正常的生活中...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            remember_warnings: {
                text: '你恭敬地向老人们道谢，记住了他们的忠告。\n\n夜色渐深，村子变得更加安静。你决定先找个地方住下，明天再开始你的调查。\n\n就在你准备离开时，其中一个老人叫住了你："年轻人，如果你真要留下来，明天去祭拜一下村里的土地庙，至少能保你平安。"',
                choices: [
                    { text: '道谢并答应明天去', nextScene: 'accept_temple_visit', effect: { flags: { hasSpokenToElder: true }, trustLevel: 5 } },
                    { text: '礼貌地说考虑一下', nextScene: 'consider_temple', effect: { flags: { hasSpokenToElder: true }, trustLevel: 0 } },
                    { text: '直接去宗祠找住处', nextScene: 'knock_ancestral_hall', effect: { flags: { hasSpokenToElder: true } } }
                ]
            },
            accept_temple_visit: {
                text: '"好，我明天一早就去。"你答道。\n\n老人满意地点点头："那就好，那就好..."说完，老人们便给你指了去宗祠的方向。\n\n你跟着指引来到了李氏宗祠，夜色深沉，只有远处偶尔传来几声狗吠。',
                choices: [
                    { text: '敲门询问住宿', nextScene: 'knock_ancestral_hall', effect: { sanity: 5 } },
                    { text: '先在周围看看', nextScene: 'explore_hall_area', effect: { sanity: -5 } }
                ]
            },
            consider_temple: {
                text: '"我会考虑的，谢谢前辈们的提醒。"你礼貌地回答。\n\n老人们互相看了看，没有再说什么。你独自一人向着村庄深处走去...\n\n月光透过云层洒在青石板路上，整座村庄陷入一种诡异的寂静之中。',
                choices: [
                    { text: '去宗祠找住处', nextScene: 'find_lodging', effect: {} },
                    { text: '找个地方先躲躲，等天亮', nextScene: 'hide_and_wait', effect: { sanity: -10 } }
                ]
            },
            explore_hall_area: {
                text: '你决定先在宗祠周围探查一下。月色下，古老的建筑显得格外阴森。\n\n突然，你听到后院有奇怪的声音，像是有人在低声哭泣...',
                choices: [
                    { text: '循声而去', nextScene: 'follow_crying', effect: { flags: { supernaturalEvents: 1 }, sanity: -10 } },
                    { text: '假装没听见，敲门', nextScene: 'knock_ancestral_hall', effect: { sanity: 5 } }
                ]
            },
            hide_and_wait: {
                text: '你在墙角找了个隐蔽的地方坐下。夜越来越深，寒意渐渐袭来。\n\n不知过了多久，你看到一个黑影从远处飘过，那身影...似乎没有脚！',
                choices: [
                    { text: '屏住呼吸不动', nextScene: 'hold_breath', effect: { sanity: -5 } },
                    { text: '追上去看看', nextScene: 'chase_shadow', effect: { flags: { supernaturalEvents: 2 }, sanity: -20 } }
                ]
            },
            follow_crying: {
                text: '你小心翼翼地循着哭声来到后院。月光斑驳中，你看到一个白衣女子跪在井边...\n\n当她回头时，你惊恐地发现——她没有脸！',
                choices: [
                    { text: '尖叫着逃跑', nextScene: 'scream_run', effect: { flags: { isPossessed: true }, sanity: -30 } },
                    { text: '闭上眼睛念经', nextScene: 'chant_buddha', effect: { flags: { hasTalisman: true }, sanity: -10 } }
                ]
            },
            // 添加 recite_sutras, listen_to_voices, flee_banyan 场景
            recite_sutras: {
                text: '你开始大声念诵经文。奇怪的是，那些低语声并没有消失，反而变得更加清晰...\n\n"没用的...经文救不了你..."一个女声在你耳边轻吻，"不如加入我们...永远留在这里..."\n\n你感觉到身体逐渐变得冰冷...',
                choices: [
                    { text: '继续念经，不求解脱', nextScene: 'continue_chanting', effect: { flags: { isPossessed: true }, sanity: -50 } },
                    { text: '停止念经，转身逃跑', nextScene: 'stop_and_run', effect: { sanity: -15 } }
                ]
            },
            listen_to_voices: {
                text: '你静下心来仔细倾听。渐渐地，你听清了那些声音——它们在诉说自己的故事。\n\n"我是三年前来的学生..." "我是村里的新娘..." "我是献祭的孩子..." 无数个声音在你脑海中交织。\n\n突然，它们齐声说道："现在轮到你了...成为我们中的一员吧！"',
                choices: [
                    { text: '接受邀请', nextScene: 'accept_invitation', effect: { flags: { isPossessed: true }, gameOver: true } },
                    { text: '激烈反抗', nextScene: 'resist_voices', effect: { sanity: -40 } }
                ]
            },
            flee_banyan: {
                text: '你立即转身离开榕树。但走了几步后，你发现周围的环境变得陌生起来...\n\n原本的村庄消失了，取而代之的是一片诡异的迷雾雾。你似乎进入了另一个空间。',
                choices: [
                    { text: '试图原路返回', nextScene: 'try_return', effect: { sanity: -10 } },
                    { text: '在迷雾中寻找出路', nextScene: 'find_path_fog', effect: { sanity: -20 } }
                ]
            },
            continue_chanting: {
                text: '你的身体越来越轻，仿佛要飘起来。经文的声音在空中回荡，但已经无法保护你了...\n\n【结局：魂归榕树】\n\n你的灵魂被榕树吸收，成为了无数求问者中的一个，永远守护着这个村庄的秘密...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            stop_and_run: {
                text: '你停止念经，转身就跑。心中的恐惧让你不敢回头，一口气跑到了村子深处。\n\n回头看时，榕树在月光下显得更加阴森...',
                choices: [
                    { text: '继续跑，远离榕树', nextScene: 'keep_running_away', effect: { sanity: -10 } },
                    { text: '找个地方冷静一下', nextScene: 'calm_down', effect: { sanity: 5 } }
                ]
            },
            accept_invitation: {
                text: '你点点头，感觉自己与他人融为一体。无尽的悲伤和怨恨涌入你的心灵...\n\n【结局：成为传说】\n\n你成为了村庄新的传说，Forever bound to this place...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            resist_voices: {
                text: '你用尽全身力气抵抗："不！我不会屈服！"\n\n强大的意志似乎起了作用，那些声音渐渐远去。你发现自己还站在榕树下，但已经大汗淋漓...',
                choices: [
                    { text: '立即离开这里', nextScene: 'leave_immediately', effect: { sanity: -20 } },
                    { text: '研究榕树的秘密', nextScene: 'study_banyan', effect: { flags: { knowsWellSecret: true }, sanity: -30 } }
                ]
            },
            try_return: {
                text: '你试图按原路返回，但无论如何走，最终都会回到同一个地方——这棵诡异的榕树下。\n\n你意识到自己被困住了...',
                choices: [
                    { text: '放弃抵抗，接受命运', nextScene: 'accept_fate', effect: { flags: { isPossessed: true }, sanity: -40 } },
                    { text: '破坏身边的红色丝带', nextScene: 'destroy_ribbons', effect: { sanity: -20 } }
                ]
            },
            find_path_fog: {
                text: '你在迷雾中摸索前进。突然，你看到前方有一丝微光...\n\n朝着光亮走去，你发现自己回到了现实世界。但手中多了一样东西——一张古老的符纸。',
                choices: [
                    { text: '仔细查看符纸', nextScene: 'examine_talisman', effect: { inventory: ['古老符纸'], flags: { hasTalisman: true } } },
                    { text: '赶紧离开这个地方', nextScene: 'hurry_leave', effect: { sanity: -10 } }
                ]
            },
            keep_running_away: {
                text: '你一直跑，直到再也看不到榕树。在一处墙角停下来喘气...\n\n这时，你注意到墙上刻着一些奇怪的符号，像是某种警告。',
                choices: [
                    { text: '研究这些符号', nextScene: 'study_symbols', effect: { sanity: -10 } },
                    { text: '继续远离', nextScene: 'continue_away', effect: { sanity: 5 } }
                ]
            },
            calm_down: {
                text: '你深呼吸，努力让自己冷静下来。几分钟后，恐惧感渐渐消退。\n\n但你知道，这个村庄远比想象的要复杂...',
                choices: [
                    { text: '回村口看看', nextScene: 'back_to_entrance', effect: {} },
                    { text: '先找个住处', nextScene: 'find_lodging', effect: {} }
                ]
            },
            leave_immediately: {
                text: '你头也不回地离开了榕树。这次的经历让你意识到，这个村庄的秘密远比你想象的要深险。',
                choices: [
                    { text: '明天就离开这里', nextScene: 'plan_leave', effect: {} },
                    { text: '为了论文，必须坚持下去', nextScene: 'persist_research', effect: { sanity: -20 } }
                ]
            },
            study_banyan: {
                text: '你决定研究这棵榕树。仔细观察后，你发现树干上刻满了小字——这是一个记录，记录着每年被献祭的人名。\n\n最新刻的名字竟然是...三年前失踪的那个学生！',
                choices: [
                    { text: '把这个发现告诉村长', nextScene: 'inform_village_head', effect: { trustLevel: 20 } },
                    { text: '偷偷调查这些名字', nextScene: 'investigate_names', effect: { sanity: -30 } }
                ]
            },
            accept_fate: {
                text: '你放弃了抵抗。雾气将你吞噬，意识逐渐模糊...\n\n你是第几个被选中的呢？也许是，也许是最后一个...\n\n【结局：雾中囚徒】\n\n你永远迷失在了村庄的迷雾中...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            destroy_ribbons: {
                text: '你开始撕扯那些红色丝带。每当一条丝带断裂，你似乎能听到一声解脱的叹息...。\n\n当所有丝带都被撕下后，迷雾散去，榕树变得普通起来。',
                choices: [
                    { text: '调查树根下有什么', nextScene: 'check_roots', effect: { flags: { knowsWellSecret: true } } },
                    { text: '任务完成，离开', nextScene: 'mission_complete', effect: { sanity: 30 } }
                ]
            },
            examine_talisman: {
                text: '符纸上用朱砂写着看不懂的咒文。虽然没有用，但拿着它，你感觉安心了不少。\n\n你意识到，这个村庄需要更深入的了解...',
                choices: [
                    { text: '请教村里的老者', nextScene: 'consult_elder', effect: { trustLevel: 10 } },
                    { text: '自己研究符纸', nextScene: 'research_talisman', effect: { sanity: -20 } }
                ]
            },
            hurry_leave: {
                text: '你拿着符纸快速离开。虽然不知道发生了什么，但直觉告诉你，刚才的经历改变了一些东西。',
                choices: [
                    { text: '找个安全的地方休息', nextScene: 'find_lodging', effect: { sanity: 10 } },
                    { text: '继续探索村庄', nextScene: 'wander_village', effect: {} }
                ]
            },
            study_symbols: {
                text: '墙上的符号像是一种古老的警告。其中一些符号让你想起了在古籍中看到的关于"阴阳界限"的记载...',
                choices: [
                    { text: '记录这些符号', nextScene: 'record_symbols', effect: { flags: { hasAncestralKey: true } } },
                    { text: '无视警告继续', nextScene: 'ignore_warning_continue', effect: { sanity: -15 } }
                ]
            },
            continue_away: {
                text: '你在村庄深处找到一个相对安全的角落。虽然逃离了险境，但心中的不安却越来越强...',
                choices: [
                    { text: '在这里过夜', nextScene: 'stay_here_night', effect: { sanity: -10 } },
                    { text: '继续寻找线索', nextScene: 'search_clues', effect: { sanity: -20 } }
                ]
            },
            back_to_entrance: {
                text: '你回到村口，老人们已经不在了。榕树依旧静静地矗立着，但似乎有什么东西改变了...',
                choices: [
                    { text: '再次走近榕树', nextScene: 'approach_again', effect: { flags: { supernaturalEvents: 2 } } },
                    { text: '直接进村', nextScene: 'direct_to_village', effect: {} }
                ]
            },
            hold_breath: {
                text: '你屏住呼吸，紧紧贴着墙壁。黑影从你面前飘过，带来一阵刺骨的寒风...\n\n等它走远后，你才敢喘气。刚才的经历让你彻底清醒了——这个村庄真的有问题！',
                choices: [
                    { text: '天亮后离开', nextScene: 'leave_at_dawn', effect: {} },
                    { text: '继续调查真相', nextScene: 'investigate_truth', effect: { flags: { supernaturalEvents: 1 } } }
                ]
            },
            chase_shadow: {
                text: '你鼓起勇气追了上去。黑影似乎发现了你，突然停下，缓缓转身...\n\n那张脸你见过——是村口的一位老人！但她的眼睛里只有空洞的黑洞...\n\n"你也看到了...对吗？"她用非人的声音说道。',
                choices: [
                    { text: '点头示意', nextScene: 'nod_accept', effect: { flags: { isPossessed: true }, sanity: -40 } },
                    { text: '转身就跑', nextScene: 'run_away_fast', effect: { sanity: -20 } }
                ]
            },
            // 添加更多缺失的场景
            leave_at_dawn: {
                text: '天色微明，你决定离开这个诡异的地方。但当你走到村口时，却发现路已经被迷雾封锁...\n\n你意识到，这个村庄不会轻易让人离开。',
                choices: [
                    { text: '尝试冲出迷雾', nextScene: 'brave_fog', effect: { sanity: -20 } },
                    { text: '另寻出路', nextScene: 'find_other_exit', effect: { sanity: -10 } }
                ]
            },
            investigate_truth: {
                text: '你必须揭开真相。这个村庄的秘密关乎太多无辜的生命...\n\n让你继续深入调查。',
                choices: [
                    { text: '从古井开始', nextScene: 'start_from_well', effect: { flags: { knowsWellSecret: true } } },
                    { text: '查阅村史资料', nextScene: 'check_village_history', effect: { sanity: -20 } }
                ]
            },
            nod_accept: {
                text: '你点了点头。瞬间，你的意识开始模糊...\n\n无数的记忆涌入你的脑海——那些曾经的祭品们的一生...',
                choices: [
                    { text: '接受命运', nextScene: 'accept_fate', effect: { flags: { isPossessed: true }, gameOver: true } },
                    { text: '激烈挣扎', nextScene: 'struggle_accept', effect: { sanity: -50 } }
                ]
            },
            run_away_fast: {
                text: '你拼尽全力逃跑。身后传来奇怪的声音...\n\n"跑吧...我们会在下一个七月半等着你..."',
                choices: [
                    { text: '跑出村庄', nextScene: 'run_out_village', effect: {} },
                    { text: '找地方躲起来', nextScene: 'hide_away', effect: { sanity: -5 } }
                ]
            },
            ask_about_ritual: {
                text: '李叔的脸色一变："祭祀是村子的大事，外人最好不要过问。"\n\n但看着你坚持的眼神，他叹了口气："好吧，但别说是我告诉你的..."',
                choices: [
                    { text: '仔细聆听', nextScene: 'listen_careful', effect: { flags: { supernaturalEvents: 1 } } },
                    { text: '暂时不问', nextScene: 'not_ask_now', effect: { sanity: 5 } }
                ]
            },
            plan_leave: {
                text: '你决定明天就离开这个诡异的地方。但是今晚必须找个地方住下...',
                choices: [
                    { text: '去宗祠过夜', nextScene: 'knock_ancestral_hall', effect: {} },
                    { text: '找个废弃的房子', nextScene: 'find_abandoned_house', effect: { sanity: -15 } }
                ]
            },
            persist_research: {
                text: '即使害怕，但你还是决定坚持下去。为了学术，也为了真相...\n\n你必须找到这个村庄的核心秘密。',
                choices: [
                    { text: '从祭祀仪式入手', nextScene: 'investigate_ritual', effect: { flags: { supernaturalEvents: 1 } } },
                    { text: '寻找古井的线索', nextScene: 'search_well_clues', effect: { flags: { knowsWellSecret: true } } }
                ]
            },
            inform_village_head: {
                text: '你找到了村委会主任，把榕树上的发现告诉了他。\n\n主任的脸色变得很难看："这事...你最好不要再查了。有些事情不知道反而更好。"',
                choices: [
                    { text: '坚持要知道真相', nextScene: 'demand_truth', effect: { trustLevel: -20 } },
                    { text: '表示理解但暗自调查', nextScene: 'secret_investigate', effect: { sanity: -10 } }
                ]
            },
            investigate_names: {
                text: '你偷偷记录下树干上的名字。回到住处，你开始查阅资料...\n\n这些失踪的人都有一个共同点：都是在七月半前后消失的。',
                choices: [
                    { text: '向警方报告', nextScene: 'report_police', effect: { trustLevel: -30 } },
                    { text: '深入调查祭祀', nextScene: 'deep_investigate', effect: { flags: { supernaturalEvents: 2 } } }
                ]
            },
            check_roots: {
                text: '你挖开树根下的泥土，发现了一个古老的木盒。\n\n盒子里是一本手写的日记，记录着这个村庄百年前的一个传说...',
                choices: [
                    { text: '仔细阅读日记', nextScene: 'read_diary', effect: { flags: { knowsWellSecret: true } } },
                    { text: '把日记带回去', nextScene: 'take_diary', effect: { inventory: ['古老日记'] } }
                ]
            },
            mission_complete: {
                text: '你感觉自己完成了一些重要的事情。虽然还不知道具体是什么，但心灵感觉平静了许多。\n\n是时候继续你的旅程了...',
                choices: [
                    { text: '完成论文离开', nextScene: 'complete_thesis', effect: { trustLevel: 30 } },
                    { text: '留下深入调查', nextScene: 'stay_investigate', effect: { sanity: -30 } }
                ]
            },
            consult_elder: {
                text: '你找到一位看起来很有学识的老人，向他请教符纸的事。\n\n老人看到符纸后大惊失色："你从哪里得到这个的？这不是普通的符纸！"',
                choices: [
                    { text: '如实告知经过', nextScene: 'tell_truth', effect: { trustLevel: 20 } },
                    { text: '模糊其词', nextScene: 'vague_answer', effect: { trustLevel: -10 } }
                ]
            },
            research_talisman: {
                text: '你回到住处，拿出纸笔临摹符纸上的咒文。渐渐地，你发现这些字符似乎蕴含着某种力量...\n\n突然，符纸发光了！',
                choices: [
                    { text: '扔掉符纸', nextScene: 'throw_talisman_away', effect: { flags: { hasTalisman: false }, sanity: 10 } },
                    { text: '继续研究', nextScene: 'continue_study', effect: { sanity: -40 } }
                ]
            },
            record_symbols: {
                text: '你用相机拍下墙上的符号。这些符号似乎形成了某种阵法...\n\n就在你拍完最后一张时，符号突然发光了！',
                choices: [
                    { text: '赶紧离开', nextScene: 'leave_quickly', effect: { sanity: 5 } },
                    { text: '触摸发光的符号', nextScene: 'touch_glowing', effect: { sanity: -30 } }
                ]
            },
            ignore_warning_continue: {
                text: '你无视警告，继续前进。但心中总有一种不安的感觉...\n\n走了没多远，你发现自己又回到了原处——这些符号似乎构成了一个迷宫。',
                choices: [
                    { text: '寻找真正的出口', nextScene: 'find_real_exit', effect: { sanity: -20 } },
                    { text: '破解符号密码', nextScene: 'decode_symbols', effect: { flags: { hasAncestralKey: true }, sanity: -30 } }
                ]
            },
            stay_here_night: {
                text: '你找了个屋檐下过夜。午夜时分，你被寒意惊醒...\n\n月光下，你看到对面屋顶上有几个黑影在跳动...\n\n它们发现你了！',
                choices: [
                    { text: '装死不动', nextScene: 'play_dead', effect: { sanity: -10 } },
                    { text: '发出声响吓走它们', nextScene: 'make_noise', effect: { sanity: -20 } }
                ]
            },
            search_clues: {
                text: '你开始在村庄四处寻找线索。在一间废弃的房屋里，你发现了一些奇怪的物品...\n\n枕头下有本日记，最后一页写着："它们来找我了...我必须把这些留给下一个来的人..."',
                choices: [
                    { text: '仔细阅读日记', nextScene: 'read_haunted_diary', effect: { flags: { knowsWellSecret: true }, sanity: -40 } },
                    { text: '带走日记离开', nextScene: 'take_haunted_diary', effect: { inventory: ['染血的手稿'] } }
                ]
            },
            approach_again: {
                text: '你再次走近榕树。这一次，你注意到树根下有什么东西在发光...\n\n走近一看，是一个古老的护身符！',
                choices: [
                    { text: '捡起护身符', nextScene: 'pickup_amulet', effect: { inventory: ['神秘护身符'], flags: { hasTalisman: true } } },
                    { text: '小心地观察', nextScene: 'observe_carefully', effect: { sanity: 5 } }
                ]
            },
            direct_to_village: {
                text: '你决定不再关注榕树，直接进入村庄深处寻找答案。\n\n村子里依旧空无一人，但气氛似乎更加诡异了...',
                choices: [
                    { text: '大声呼喊找人', nextScene: 'shout_for_help', effect: { sanity: -15 } },
                    { text: '挨家挨户查看', nextScene: 'check_houses', effect: { sanity: -10 } }
                ]
            },
            scream_run: {
                text: '你失声尖叫，转身就跑。身后传来诡异的笑声...\n\n跑着跑着，你发现自己又回到了榕树下。',
                choices: [
                    { text: '再次逃跑', nextScene: 'run_again', effect: { flags: { supernaturalEvents: 2 }, sanity: -30 } },
                    { text: '背对榕树许愿', nextScene: 'make_wish', effect: { flags: { isPossessed: true }, sanity: -20 } }
                ]
            },
            chant_buddha: {
                text: '你闭上眼睛开始念经。出乎意料的是，经文似乎真的起了作用...\n\n眼前的幻象消失了，你发现自己还站在原地。',
                choices: [
                    { text: '念更多经文保佑', nextScene: 'chant_more', effect: { sanity: 10 } },
                    { text: '念完就走', nextScene: 'finish_chanting', effect: { sanity: 5 } }
                ]
            },
            // 添加缺失的其他场景
            enter_ancestral_hall: {
                text: '你进入了李氏宗祠。里面供奉着祖先牌位，香火不断。\n\n守祠人李叔从后面走出来："就是你了？老人们已经说过了。跟我来吧。"',
                choices: [
                    { text: '跟着他去房间', nextScene: 'go_to_room', effect: { sanity: -5 } },
                    { text: '询问关于祭祀的事', nextScene: 'ask_about_ritual', effect: { sanity: -10 } }
                ]
            },
            // 添加缺失的古井相关场景
            search_well_clues: {
                text: '你开始在房间里仔细寻找关于古井的线索。\\n\\n在床下的暗格里，你发现了一叠剪报和几张照片...\\n\\n这些记录显示，过去十年间，每到中元节后，都会有一个外来者神秘失踪。警方调查无果，最终都被定性为意外。\\n\\n其中一张照片的背面写着："他们在井下等着我...下一个可能就是看这张照片的人..."',
                choices: [
                    { text: '继续深挖这些失踪案件', nextScene: 'investigate_disappearances', effect: { sanity: -40, flags: { supernaturalEvents: 3 } } },
                    { text: '今晚就去古井看看', nextScene: 'investigate_well_night', effect: { sanity: -30, flags: { knowsWellSecret: true } } },
                    { text: '把证据收好，先睡觉', nextScene: 'sleep_with_evidence', effect: { sanity: -10 } }
                ]
            },
            investigate_well_night: {
                text: '深夜，你悄悄来到后院。月光下，古井显得格外阴森...\\n\\n井口的石板似乎被移动过，隐约能看到井下有什么东西在发光。\\n\\n突然，一只冰冷的手搭在了你的肩膀上！',
                choices: [
                    { text: '惊叫着推开它', nextScene: 'push_figure', effect: { sanity: -20 } },
                    { text: '慢慢回头看是谁', nextScene: 'check_behind', effect: { sanity: -15 } },
                    { text: '念经保佑', nextScene: 'chant_protection', effect: { sanity: 5 } }
                ]
            },
            investigate_disappearances: {
                text: '你发现了一个规律：所有失踪者都在调查古井，而且都在找到"真相"后消失。\\n\\n最后一份记录是一段音频："...井不是诅咒，是封印！他们在井下保护着我们，不能让他们出来！每年必须有人下去安抚他们..."\\n\\n【结局：真相的代价】\\n\\n当你了解真相的那一刻，你也成为了他们中的一员...',
                choices: [
                    { text: '重新开始', nextScene: 'village_entrance', effect: { reset: true, restart: true } }
                ]
            },
            find_well_source: {
                text: '你找到了那口传说中的古井。井口被层层符纸封印，但仍能感受到下面传来的强大邪气...\\n\\n仔细观察后，你发现这些符纸并非镇压，而是在维持某种平衡。\\n\\n井底传来声音："外面的人...封印快要维持不住了...你需要做出选择..."',
                choices: [
                    { text: '加固封印', nextScene: 'strengthen_seal', effect: { sanity: -30, flags: { hasAncestralKey: true } } },
                    { text: '打破封印', nextScene: 'break_seal', effect: { sanity: -50, flags: { supernaturalEvents: 5 } } },
                    { text: '下井看看', nextScene: 'descend_well', effect: { sanity: -70, flags: { isLost: true } } }
                ]
            },
            start_from_well: {
                text: '你决定从古井开始调查。根据日记的描述，井里封印着某种古老的东西...\\n\\n来到后院，你发现井口不仅有符纸，还有一个复杂的法阵。\\n\\n正当你仔细研究时，守祠人出现在你身后："你在找什么？有些东西，还是不碰为好。"',
                choices: [
                    { text: '询问实话实说', nextScene: 'honest_inquiry', effect: { trustLevel: 10 } },
                    { text: '假装只是好奇', nextScene: 'pretend_curiosity', effect: { sanity: 5 } },
                    { text: '直接询问古井的秘密', nextScene: 'demand_well_secret', effect: { sanity: -20, trustLevel: -20 } }
                ]
            }
        };

        // 场景引用映射（简化处理未实现的场景）
        const sceneAliases = {
            // 古井相关场景不再在 aliases 中映射，直接使用实际场景
            // 新增场景的映射
            push_figure: 'continue_diary',
            check_behind: 'continue_diary',
            chant_protection: 'use_talisman',
            sleep_with_evidence: 'sleep_after_diary',
            strengthen_seal: 'destroy_well',
            break_seal: 'destroy_well',
            descend_well: 'sacrifice_self',
            honest_inquiry: 'ask_about_secrets',
            pretend_curiosity: 'ask_about_secrets',
            demand_well_secret: 'refuse_warning',
            accept_talisman: 'confident_response',
            refuse_talisman: 'confident_response',
            ask_about_talisman: 'confident_response',
            retract_hand: 'examine_incense',
            take_coin: 'examine_incense',
            recite_sutras: 'touch_ribbons',
            listen_to_voices: 'touch_ribbons',
            flee_banyan: 'touch_ribbons',
            follow_sounds: 'enter_village_after_observation',
            find_villager: 'enter_village_after_observation',
            go_to_ancestral_hall: 'find_lodging',
            ask_granny: 'find_other_house',
            buy_goods: 'find_other_house',
            return_to_hall: 'find_other_house',
            try_open_well: 'explore_hall',
            flee_well: 'explore_hall',
            offer_paper_money: 'explore_hall',
            press_for_details: 'ask_about_secrets',
            wander_village: 'ask_about_secrets',
            ask_about_well: 'refuse_warning',
            disregard_warnings: 'refuse_warning',
            remember_warnings: 'refuse_warning',
            ask_about_night_rules: 'knock_ancestral_hall',
            leave_hall: 'knock_ancestral_hall',
            enter_ancestral_hall: 'go_to_ancestral_hall',
            enter_hall_quickly: 'ask_who_coming',
            take_photo: 'ask_who_coming',
            approach_figures: 'ask_who_coming',
            scream_to_hall: 'look_back',
            recite_defense: 'look_back',
            ask_rules: 'lock_hall_door',
            ask_about_outside: 'lock_hall_door',
            look_mirror: 'go_to_room',
            continue_diary: 'check_desk',
            sleep_after_diary: 'check_desk',
            // search_well_clues 已移除，使用实际场景
            open_door_li: 'rest_bed',
            question_knocker: 'rest_bed',
            rush_escape: 'ignore_knock',
            confront_ghost: 'ignore_knock',
            ask_ghost_identity: 'scream_encounter',
            find_more_charms: 'use_talisman',
            flee_village: 'use_talisman',
            return_hall_wait: 'flee_village',
            find_other_exit: 'flee_village',
            sabotage_ritual: 'investigate_festival',
            // find_well_source 已移除，使用实际场景
            new_exorcism: 'unite_villagers',
            stay_rebuild: 'leave_freely',
            publish_story: 'leave_freely',
            talk_to_girl: 'brave_exploration',
            run_away: 'brave_exploration',
            hide_and_watch: 'brave_exploration',
            ask_caller: 'ask_about_them',
            ask_protection: 'ask_about_them',
            stand_still: 'look_back',
            // 移除重复的sabotage_ritual映射
            // find_well_source 已移除，使用实际场景
            // 移除重复的new_exorcism映射
            // 新场景的映射
            leave_at_dawn: 'find_lodging',
            investigate_truth: 'investigate_festival',
            scream_run: 'scream_encounter',
            chant_buddha: 'use_talisman',
            nod_accept: 'stand_still',
            run_away_fast: 'run_away',
            ask_about_ritual: 'lock_hall_door',
            accept_temple_visit: 'remember_warnings',
            consider_temple: 'remember_warnings',
            explore_hall_area: 'explore_hall',
            hide_and_wait: 'brave_exploration',
            hold_breath: 'use_talisman',
            chase_shadow: 'look_back',
            follow_crying: 'scream_encounter',
            // 添加新场景的映射
            continue_chanting: 'continue_chanting',
            stop_and_run: 'stop_and_run',
            accept_invitation: 'accept_invitation',
            resist_voices: 'resist_voices',
            accept_fate: 'accept_fate',
            destroy_ribbons: 'destroy_ribbons',
            examine_talisman: 'examine_talisman',
            hurry_leave: 'hurry_leave',
            study_symbols: 'study_symbols',
            keep_running_away: 'keep_running_away',
            calm_down: 'calm_down',
            leave_immediately: 'leave_immediately',
            study_banyan: 'study_banyan',
            try_return: 'try_return',
            find_path_fog: 'find_path_fog',
            plan_leave: 'plan_leave',
            persist_research: 'persist_research',
            inform_village_head: 'inform_village_head',
            investigate_names: 'investigate_names',
            check_roots: 'check_roots',
            mission_complete: 'mission_complete',
            consult_elder: 'consult_elder',
            research_talisman: 'research_talisman',
            record_symbols: 'record_symbols',
            ignore_warning_continue: 'ignore_warning_continue',
            stay_here_night: 'stay_here_night',
            search_clues: 'search_clues',
            back_to_entrance: 'back_to_entrance',
            leave_at_dawn: 'leave_at_dawn',
            investigate_truth: 'investigate_truth',
            nod_accept: 'nod_accept',
            run_away_fast: 'run_away_fast',
            ask_about_ritual: 'ask_about_ritual',
            approach_again: 'approach_again',
            direct_to_village: 'direct_to_village',
            scream_run: 'scream_run',
            chant_buddha: 'chant_buddha',
            brave_fog: 'brave_fog',
            find_other_exit: 'find_other_exit',
            start_from_well: 'find_well_source',
            check_village_history: 'check_village_history',
            demand_truth: 'demand_truth',
            secret_investigate: 'secret_investigate',
            report_police: 'report_police',
            deep_investigate: 'deep_investigate',
            read_diary: 'read_diary',
            take_diary: 'take_diary',
            complete_thesis: 'complete_thesis',
            stay_investigate: 'stay_investigate',
            tell_truth: 'tell_truth',
            vague_answer: 'vague_answer',
            throw_talisman_away: 'throw_talisman',
            leave_quickly: 'leave_quickly',
            touch_glowing: 'touch_glowing',
            find_real_exit: 'find_other_exit',
            decode_symbols: 'decode_symbols',
            play_dead: 'play_dead',
            make_noise: 'make_noise',
            read_haunted_diary: 'read_diary',
            take_haunted_diary: 'take_haunted_diary',
            pickup_amulet: 'pickup_amulet',
            observe_carefully: 'observe_carefully',
            shout_for_help: 'shout_for_help',
            check_houses: 'check_houses',
            run_again: 'run_again',
            make_wish: 'make_wish',
            chant_more: 'chant_more',
            finish_chanting: 'finish_chanting',
            find_abandoned_house: 'find_other_house',
            investigate_ritual: 'investigate_festival',
            listen_careful: 'listen_careful',
            not_ask_now: 'go_to_room',
            struggle_accept: 'resist_voices',
            run_out_village: 'find_lodging',
            hide_away: 'hide_and_watch',
            find_other_exit: 'find_other_exit'
        };

        // 游戏引擎
        function renderScene(sceneName) {
            const scene = scenes[sceneName] || scenes[sceneAliases[sceneName]];
            if (!scene) {
                console.error('Scene not found:', sceneName);
                return;
            }

            gameState.currentScene = sceneName;

            // 更新场景容器的数据属性
            const sceneContainer = document.querySelector('.scene-container');
            if (sceneContainer) {
                sceneContainer.setAttribute('data-scene', sceneName);
            }

            // 更新场景文字
            const sceneText = document.getElementById('sceneText');
            if (scene.isTitleScreen) {
                sceneText.style.fontSize = '1em'; // 重置大小，让HTML内部样式控制
                sceneText.style.textAlign = 'center';
                sceneText.style.lineHeight = '1.5';
                // 标题画面使用HTML渲染
                sceneText.innerHTML = scene.text;
            } else {
                sceneText.style.fontSize = '1.2em';
                sceneText.style.textAlign = 'left';
                sceneText.style.lineHeight = '1.8';
                // 普通场景使用纯文本
                sceneText.textContent = scene.text;
            }

            // 检查是否为结局场景
            if (scene.text.includes('【结局：')) {
                gameState.gameOver = true;
            } else {
                gameState.gameOver = false;
            }

            // 更新选项
            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';

            scene.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = scene.isTitleScreen ? 'control-button' : 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => makeChoice(choice);
                choicesContainer.appendChild(button);
            });

            // 添加控制按钮（非标题画面）
            if (!scene.isTitleScreen && sceneName !== 'about') {
                const controlsHtml = `
                    <div class="control-buttons">
                        <button class="control-button" id="goBackBtn" disabled>回退</button>
                        <button class="control-button" id="saveBtn">保存</button>
                        <button class="control-button" id="menuBtn">标题画面</button>
                    </div>
                `;
                choicesContainer.insertAdjacentHTML('beforeend', controlsHtml);

                // 绑定控制按钮事件
                document.getElementById('goBackBtn').onclick = goBack;
                document.getElementById('saveBtn').onclick = () => {
                    saveGame();
                    showMessage('游戏已保存！');
                };
                document.getElementById('menuBtn').onclick = () => confirmReturnToMenu();

                // 更新回退按钮状态
                updateGoBackButton();
            }

            updateUI();
            saveGame();
        }

        function makeChoice(choice) {
            if (gameState.gameOver) {
                if (choice.effect && (choice.effect.restart || choice.effect.reset)) {
                    resetGameForNew();
                    gameState.currentScene = 'village_entrance';
                    renderScene('village_entrance');
                    return;
                }
            }

            // 处理特殊选项
            if (choice.special === 'load') {
                const saved = localStorage.getItem('villageHorrorGame');
                if (saved) {
                    loadGame();
                    renderScene(gameState.currentScene);
                    showMessage('游戏已加载！');
                } else {
                    showMessage('没有找到存档！');
                }
                return;
            }

            // 记录当前状态到历史
            gameState.choiceHistory.push({
                scene: gameState.currentScene,
                sanity: gameState.sanity,
                trustLevel: gameState.trustLevel,
                inventory: [...gameState.inventory],
                flags: { ...gameState.flags }
            });

            // 应用效果
            if (choice.effect) {
                if (choice.effect.resetGame) {
                    // 重置游戏但保留历史
                    resetGameForNew();
                } else {
                    applyEffects(choice.effect);
                }
            }

            // 触发超自然事件
            if (choice.supernaturalEvent || Math.random() < 0.1) {
                triggerSupernaturalEvent();
            }

            // 记录选择
            gameState.choices.push({
                scene: gameState.currentScene,
                choice: choice.text,
                timestamp: Date.now()
            });

            // 标记游戏已开始
            if (gameState.currentScene !== 'title_screen') {
                gameState.gameStarted = true;
            }

            // 切换场景
            const nextScene = choice.nextScene || sceneAliases[choice.nextScene] || choice.nextScene;
            if (nextScene) {
                gameState.currentScene = nextScene;
                renderScene(nextScene);
            }

            // 检查游戏结束
            checkGameOver();
        }

        function applyEffects(effects) {
            if (effects.sanity !== undefined) {
                gameState.sanity = Math.max(0, Math.min(100, gameState.sanity + effects.sanity));
            }

            if (effects.trustLevel !== undefined) {
                gameState.trustLevel = Math.max(-100, Math.min(100, gameState.trustLevel + effects.trustLevel));
            }

            if (effects.inventory) {
                effects.inventory.forEach(item => {
                    if (!gameState.inventory.includes(item)) {
                        gameState.inventory.push(item);
                    }
                });
            }

            if (effects.flags) {
                Object.assign(gameState.flags, effects.flags);
            }

            if (effects.gameOver) {
                gameOver('你触发了游戏结束条件...');
            }
        }

        function triggerSupernaturalEvent() {
            gameState.flags.supernaturalEvents++;
            document.body.classList.add('glitch');
            setTimeout(() => {
                document.body.classList.remove('glitch');
            }, 300);

            // 简单的音频效果
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 100 + Math.random() * 200;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                // 忽略音频错误
            }
        }

        function updateUI() {
            // 更新理智值
            const sanityBar = document.getElementById('sanityBar');
            sanityBar.style.width = `${gameState.sanity}%`;

            // 更新村民好感度
            document.getElementById('trustLevel').textContent = gameState.trustLevel;

            // 更新时间
            const days = ['初一', '初二', '初三', '初四', '初五', '初六', '初七'];
            const timeDisplay = document.getElementById('timeDisplay');
            const timeOfDay = gameState.isNight ? '夜' : '日';
            timeDisplay.textContent = `农历七月${days[gameState.currentDay - 1]} ${timeOfDay}`;

            // 更新物品栏
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.textContent = item;
                inventoryList.appendChild(itemElement);
            });
        }

        function checkGameOver() {
            if (gameState.sanity <= 0) {
                gameOver('你已经彻底疯了...');
            } else if (gameState.flags.isPossessed && gameState.flags.supernaturalEvents > 5) {
                gameOver('你的身体已经不再属于你自己...');
            } else if (gameState.trustLevel < -50) {
                gameOver('村民们不再信任你，你被赶出了村子...');
            }
        }

        function gameOver(message) {
            gameState.gameOver = true;
            const sceneText = document.getElementById('sceneText');
            sceneText.innerHTML = `<span style="color: #8b0000; font-size: 1.3em;">${message}</span>\n\n游戏结束。\n\n请点击"重新开始"或使用返回按钮回到标题画面。`;

            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';

            // 添加重新开始按钮
            const restartBtn = document.createElement('button');
            restartBtn.className = 'choice-button';
            restartBtn.textContent = '【重新开始】';
            restartBtn.onclick = () => {
                resetGame();
            };
            choicesContainer.appendChild(restartBtn);

            // 添加返回标题画面按钮
            const menuBtn = document.createElement('button');
            menuBtn.className = 'choice-button';
            menuBtn.textContent = '【返回标题画面】';
            menuBtn.onclick = () => {
                renderScene('title_screen');
            };
            choicesContainer.appendChild(menuBtn);
        }

        function resetGame() {
            gameState.currentScene = 'title_screen';
            gameState.sanity = 80;
            gameState.trustLevel = 0;
            gameState.inventory = [];
            gameState.flags = {
                hasSpokenToElder: false,
                knowsWellSecret: false,
                isPossessed: false,
                hasTalisman: false,
                hasAncestralKey: false,
                festivalPrepared: false,
                supernaturalEvents: 0
            };
            gameState.choices = [];
            gameState.choiceHistory = [];
            gameState.currentDay = 1;
            gameState.isNight = true;
            gameState.gameOver = false;
            gameState.gameStarted = false;

            localStorage.removeItem('villageHorrorGame');
            renderScene('title_screen');
        }

        function resetGameForNew() {
            gameState.sanity = 80;
            gameState.trustLevel = 0;
            gameState.inventory = [];
            gameState.flags = {
                hasSpokenToElder: false,
                knowsWellSecret: false,
                isPossessed: false,
                hasTalisman: false,
                hasAncestralKey: false,
                festivalPrepared: false,
                supernaturalEvents: 0
            };
            gameState.choices = [];
            gameState.choiceHistory = [];
            gameState.currentDay = 1;
            gameState.isNight = true;
            gameState.gameOver = false;
            gameState.gameStarted = true;

            // 清除旧存档
            localStorage.removeItem('villageHorrorGame');
        }

        function goBack() {
            // 禁止在游戏结束状态回退
            if (gameState.gameOver) {
                showMessage('游戏已结束，无法回退。请选择"重新开始"');
                return;
            }

            if (gameState.choiceHistory.length > 0) {
                const previousState = gameState.choiceHistory.pop();
                gameState.currentScene = previousState.scene;
                gameState.sanity = previousState.sanity;
                gameState.trustLevel = previousState.trustLevel;
                gameState.inventory = previousState.inventory;
                gameState.flags = previousState.flags;

                // 移除最后一个选择记录
                if (gameState.choices.length > 0) {
                    gameState.choices.pop();
                }

                renderScene(gameState.currentScene);
                showMessage('已回退到上一步');
            }
        }

        function updateGoBackButton() {
            const goBackBtn = document.getElementById('goBackBtn');
            if (goBackBtn) {
                // 如果游戏结束，禁用回退按钮
                if (gameState.gameOver) {
                    goBackBtn.disabled = true;
                    goBackBtn.textContent = '回退（不可用）';
                    return;
                }

                goBackBtn.disabled = gameState.choiceHistory.length === 0;
                if (gameState.choiceHistory.length === 0) {
                    goBackBtn.textContent = '回退';
                } else {
                    goBackBtn.textContent = '回退';
                }
            }
        }

        function confirmReturnToMenu() {
            if (confirm('确定要返回标题画面吗？未保存的进度将会丢失。')) {
                saveGame(); // 保存当前进度
                renderScene('title_screen');
            }
        }

        function showMessage(text) {
            const sceneText = document.getElementById('sceneText');
            const originalText = sceneText.textContent;
            sceneText.innerHTML = `<span style="color: #8b0000; font-weight: bold;">${text}</span>`;
            setTimeout(() => {
                sceneText.textContent = originalText;
            }, 2000);
        }

        function saveGame() {
            localStorage.setItem('villageHorrorGame', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('villageHorrorGame');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.assign(gameState, data);
                } catch (e) {
                    console.error('Failed to load game:', e);
                }
            }
        }

        // 启动游戏
        function startGame() {
            loadGame();
            renderScene(gameState.currentScene || 'title_screen');
        }

        // 多重启动保险
        if (document.readyState === 'complete') {
            startGame();
        } else if (document.readyState === 'interactive') {
            setTimeout(startGame, 100);
        } else {
            document.addEventListener('DOMContentLoaded', startGame);
            window.addEventListener('load', startGame);
        }

        // 最后的保险
        setTimeout(startGame, 1000);

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                const buttons = document.querySelectorAll('.choice-button, .control-button:not(#goBackBtn):not(#saveBtn):not(#menuBtn)');
                if (buttons[index]) {
                    buttons[index].click();
                }
            } else if (e.key === 'Escape') {
                // ESC键返回标题画面
                if (gameState.currentScene !== 'title_screen') {
                    confirmReturnToMenu();
                }
            } else if (e.key === 'z' && e.ctrlKey) {
                // Ctrl+Z 回退
                e.preventDefault();
                const btn = document.getElementById('goBackBtn');
                if (btn && !btn.disabled) {
                    goBack();
                }
            }
        });

        console.log('Game script initialized');
    </script>
</body>
</html>